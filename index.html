<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>heeh.ee</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

/* nÃ¤htamatu audio unlock */
#unlock {
  position: fixed;
  inset: 0;
  z-index: 9999;
}

/* gif */
#gif {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 120px;
  transform-origin: bottom left;
  transform: scale(0.15);
  transition: transform 0.06s linear;
}
</style>
</head>

<body>

<div id="unlock"></div>
<img id="gif" src="hehe-dance.gif">

<script>
/* =====================
   STATE
===================== */
let audio, ctx, analyser, data;
let started = false;

let energyHistory = [];
let bassHistory = [];

let inChorus = false;
let chorusStart = 0;

/* =====================
   ELEMENTS
===================== */
const gif = document.getElementById("gif");
const unlock = document.getElementById("unlock");

/* =====================
   START (AINUS LUBATUD)
===================== */
unlock.addEventListener("pointerdown", () => {
  if (started) return;
  started = true;
  unlock.remove();

  audio = new Audio("billijean.mp3");
  audio.loop = true;

  ctx = new AudioContext();
  analyser = ctx.createAnalyser();
  analyser.fftSize = 512;

  const source = ctx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(ctx.destination);

  data = new Uint8Array(analyser.frequencyBinCount);

  audio.play();
  requestAnimationFrame(loop);
});

/* =====================
   ANALYSIS LOOP
===================== */
function loop() {
  analyser.getByteFrequencyData(data);

  /* ----- BASS & ENERGY ----- */
  let bass = 0;
  for (let i = 0; i < 15; i++) bass += data[i];
  bass /= 15;

  let energy = data.reduce((a,b) => a + b, 0) / data.length;

  bassHistory.push(bass);
  energyHistory.push(energy);

  if (bassHistory.length > 120) bassHistory.shift();
  if (energyHistory.length > 120) energyHistory.shift();

  const avgBass =
    bassHistory.reduce((a,b) => a+b, 0) / bassHistory.length;

  const avgEnergy =
    energyHistory.reduce((a,b) => a+b, 0) / energyHistory.length;

  /* ----- CHORUS DETECTION ----- */
  const bassBoost = bass > avgBass * 1.6;
  const energyBoost = energy > avgEnergy * 1.4;

  if (!inChorus && bassBoost && energyBoost) {
    inChorus = true;
    chorusStart = performance.now();
  }

  // chorus kestab vÃ¤hemalt 6s
  if (inChorus && performance.now() - chorusStart > 6000) {
    if (!bassBoost) inChorus = false;
  }

  /* ----- VISUAL RESPONSE ----- */
  let scale;

  if (inChorus) {
    // ðŸ”¥ CHORUS MODE
    scale = 2.2 + (bass / 255) * 4;
  } else {
    // normaalne pulse
    scale = 0.4 + (energy / 255) * 1.8;
  }

  gif.style.transform = `scale(${scale})`;

  requestAnimationFrame(loop);
}
</script>

</body>
</html>
