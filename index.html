<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>heeh.ee</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

/* nähtamatu unlock */
#unlock {
  position: fixed;
  inset: 0;
  z-index: 9999;
}

/* visuaali konteiner (kaamera) */
#stage {
  position: fixed;
  inset: 0;
  will-change: transform, filter;
}

/* GIF */
#gif {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 120px;
  transform-origin: bottom left;
  transition: transform 0.06s linear;
}
</style>
</head>

<body>

<div id="unlock"></div>
<div id="stage">
  <img id="gif" src="hehe-dance.gif" alt="dance">
</div>

<script>
/* =====================
   STATE
===================== */
let audio, ctx, analyser, data;
let started = false;

let energyHist = [];
let bassHist = [];

let inChorus = false;
let chorusStart = 0;
let chorusCount = 0;

let shake = 0;

/* =====================
   ELEMENTS
===================== */
const unlock = document.getElementById("unlock");
const stage = document.getElementById("stage");
const gif = document.getElementById("gif");

/* =====================
   START (AINUS LUBATUD)
===================== */
unlock.addEventListener("pointerdown", () => {
  if (started) return;
  started = true;
  unlock.remove();

  audio = new Audio("billijean.mp3");
  audio.loop = true;

  ctx = new AudioContext();
  analyser = ctx.createAnalyser();
  analyser.fftSize = 512;

  const src = ctx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(ctx.destination);

  data = new Uint8Array(analyser.frequencyBinCount);

  audio.play();
  requestAnimationFrame(loop);
});

/* =====================
   LOOP
===================== */
function loop() {
  analyser.getByteFrequencyData(data);

  /* --- bass & energy --- */
  let bass = 0;
  for (let i = 0; i < 16; i++) bass += data[i];
  bass /= 16;

  let energy = 0;
  for (let i = 0; i < data.length; i++) energy += data[i];
  energy /= data.length;

  bassHist.push(bass);
  energyHist.push(energy);
  if (bassHist.length > 120) bassHist.shift();
  if (energyHist.length > 120) energyHist.shift();

  const avgBass = bassHist.reduce((a,b)=>a+b,0)/bassHist.length;
  const avgEnergy = energyHist.reduce((a,b)=>a+b,0)/energyHist.length;

  /* --- CHORUS DETECTION --- */
  const bassBoost = bass > avgBass * 1.7;
  const energyBoost = energy > avgEnergy * 1.45;

  if (!inChorus && bassBoost && energyBoost) {
    inChorus = true;
    chorusStart = performance.now();
    chorusCount++;
  }

  // chorus kestab min 6s, lõpeb kui bass kukub
  if (inChorus && performance.now() - chorusStart > 6000) {
    if (!bassBoost) inChorus = false;
  }

  /* --- VISUALS --- */
  let scale;
  let filter = "none";

  if (inChorus) {
    // iga chorus agressiivsem
    const aggression = Math.min(1.5, chorusCount * 0.35);

    // fullscreen overshoot
    scale = 2.8 + aggression * 3 + (bass / 255) * 2;

    // strobe / invert bass hitil
    if (bass > avgBass * 2.2) {
      filter = "invert(1)";
      shake = 18 * aggression;
    }
  } else {
    // normaalne pulse
    scale = 0.35 + (energy / 255) * 1.6;
  }

  /* --- CAMERA SHAKE --- */
  const sx = (Math.random() - 0.5) * shake;
  const sy = (Math.random() - 0.5) * shake;
  shake *= 0.85;

  stage.style.transform =
    `translate(${sx}px, ${sy}px)`;

  stage.style.filter = filter;

  gif.style.transform = `scale(${scale})`;

  requestAnimationFrame(loop);
}
</script>

</body>
</html>
